name: æ—¥å¸¸æ„å»º

on:
  push:
    branches:
      - '**'
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç”Ÿæˆ tagï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      datetime: ${{ steps.tag.outputs.datetime }}
      pkg: ${{ steps.pkg.outputs.pkg }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          if [ -z "$pkg" ]; then
            echo "Cannot find package name in pubspec.yaml" >&2
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: tag
        run: |
          datetime=$(date -u +"%Y.%m.%d.%H.%M")
          echo "tag=v${datetime}" >> $GITHUB_OUTPUT
          echo "datetime=${datetime}" >> $GITHUB_OUTPUT

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º Windows-${{ matrix.arch }}
    needs: prepare
    strategy:
      matrix:
        include:
          - arch: x64
            runs-on: windows-latest
          - arch: arm64
            runs-on: windows-11-arm
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: |
          cargo install rinf_cli
          rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: æ„å»ºåº”ç”¨ç¨‹åº
        run: |
          flutter build windows --release -v
          flutter build windows --debug -v

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        shell: pwsh
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          PKG: ${{ needs.prepare.outputs.pkg }}
          ARCH: ${{ matrix.arch }}
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          $pkg = $env:PKG
          $tag = $env:TAG
          $arch = $env:ARCH

          $releaseZip = "${pkg}-windows-${tag}-${arch}.zip"
          $debugZip   = "${pkg}-windows-${tag}-${arch}-debug.zip"

          # Release
          Compress-Archive -Path "build/windows/$arch/runner/Release/*" `
            -DestinationPath "dist/$releaseZip"

          # Debug
          Compress-Archive -Path "build/windows/$arch/runner/Debug/*" `
            -DestinationPath "dist/$debugZip"

          Write-Host "Generated: dist\$releaseZip"
          Write-Host "Generated: dist\$debugZip"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          # artifact åç§°åŒ…å«åŒ…å / arch / tagï¼Œä¾¿äºåŒºåˆ†
          name: ${{ needs.prepare.outputs.pkg }}-windows-${{ matrix.arch }}-${{ needs.prepare.outputs.tag }}
          path: dist/*.zip
          retention-days: 7

  # ------------ Releaseï¼ˆä½¿ç”¨ prepare è¾“å‡ºçš„ tag & pkgï¼‰ ------------
  release:
    name: å‘å¸ƒ Releaseï¼ˆè‡ªåŠ¨ä¸Šä¼ äº§ç‰©ï¼‰
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: å‘å¸ƒæ„å»ºäº§ç‰©åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨æå‰ç”Ÿæˆçš„ tagï¼ˆsoftprops ä¼šåœ¨å¿…è¦æ—¶åˆ›å»ºè¯¥ tagï¼‰
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: æ—¥å¸¸æ„å»º ${{ needs.prepare.outputs.datetime }}
          body: |
            ## ğŸš€ æ—¥å¸¸è‡ªåŠ¨æ„å»º

            **åŒ…å**: `${{ needs.prepare.outputs.pkg }}`
            **æ„å»ºæ—¶é—´**: ${{ needs.prepare.outputs.datetime }}
            **æäº¤å“ˆå¸Œ**: ${{ github.sha }}

          files: artifacts/**/*.zip
          prerelease: true
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
