name: æ—¥å¸¸æ„å»º

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©å‡Œæ™¨ 0 ç‚¹ï¼ˆUTCï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: æ„å»ºå¹¶å‘å¸ƒ
    strategy:
      matrix:
        include:
          - arch: x64
            runs-on: windows-latest
          - arch: arm64
            runs-on: windows-11-arm  # GitHub æä¾› ARM runner
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master  # master é€šé“æ”¯æŒ Windows ARM64
          cache: false

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: |
          cargo install rinf_cli
          rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: æ„å»º Windows ç‰ˆæœ¬
        run: flutter build windows --release

      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: tag
        run: |
          $datetime = Get-Date -Format "yyyy.MM.dd.HH.mm"
          $tag = "v$datetime"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "datetime=$datetime" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          cd build/windows/${{ matrix.arch }}/runner/Release
          Compress-Archive -Path * -DestinationPath ../../../../../loopback_manager-windows-${{ matrix.arch }}.zip
        shell: pwsh

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Actions
        uses: actions/upload-artifact@v4
        with:
          name: loopback_manager-windows-${{ matrix.arch }}-${{ steps.tag.outputs.tag }}
          path: loopback_manager-windows-${{ matrix.arch }}.zip
          retention-days: 90

      # âœ… x64 ä»»åŠ¡ï¼šåˆ›å»ºæ ‡ç­¾ + Release
      - name: åˆ›å»º Git æ ‡ç­¾
        if: matrix.arch == 'x64'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.tag.outputs.tag }}
          git push origin ${{ steps.tag.outputs.tag }}
        shell: pwsh

      - name: åˆ›å»º GitHub Releaseï¼ˆåˆå§‹å‘å¸ƒï¼‰
        if: matrix.arch == 'x64'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: æ—¥å¸¸æ„å»º ${{ steps.tag.outputs.datetime }}
          body: |
            ## ğŸš€ æ—¥å¸¸è‡ªåŠ¨æ„å»º

            **æ„å»ºæ—¶é—´**: ${{ steps.tag.outputs.datetime }}
            **æäº¤å“ˆå¸Œ**: ${{ github.sha }}

            ### ğŸ“¦ ä¸‹è½½
            - Windows x64 ç‰ˆæœ¬
            - Windows ARM64 ç‰ˆæœ¬

            ### âš ï¸ æ³¨æ„
            è¿™æ˜¯è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå……åˆ†æµ‹è¯•çš„åŠŸèƒ½ã€‚

            ---
            è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions
          files: loopback_manager-windows-x64.zip
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # âœ… ARM64 ä»»åŠ¡ï¼šç­‰ x64 å‘å¸ƒå®Œåï¼Œè¿½åŠ ä¸Šä¼  ARM64 äº§ç‰©
      - name: é™„åŠ ä¸Šä¼  ARM64 ç‰ˆæœ¬åˆ° Release
        if: matrix.arch == 'arm64'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: loopback_manager-windows-arm64.zip
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
