name: å‘å¸ƒæ­£å¼ç‰ˆ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç‰ˆæœ¬å·ï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.pkg.outputs.pkg }}
      version: ${{ steps.ver.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” æ£€æµ‹åˆ°åŒ…å: $pkg"
          if [ -z "$pkg" ]; then
            echo "::error::æ— æ³•ä» pubspec.yaml æ‰¾åˆ°åŒ…å"
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: è¯»å–æˆ–ç”Ÿæˆç‰ˆæœ¬å·
        id: ver
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            version="${{ github.event.inputs.version }}"
            echo "ğŸ“ æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version"
          else
            raw=$(grep '^version:' pubspec.yaml | awk '{print $2}')
            version="${raw%%+*}"
            echo "ğŸ“¦ ä» pubspec.yaml è¯»å–ç‰ˆæœ¬: $version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ç¡®å®š Tag åç§°
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            tag="v${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            tag="${{ github.ref_name }}"
          else
            tag="v${{ steps.ver.outputs.version }}"
          fi
          echo "ğŸ·ï¸ Tag åç§°: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          tag_version="${{ steps.tag.outputs.tag }}"
          pubspec_version="${{ steps.ver.outputs.version }}"
          
          # ç§»é™¤ tag ä¸­çš„ 'v' å‰ç¼€
          tag_version_clean="${tag_version#v}"
          
          echo "ğŸ” ç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "  Tag ç‰ˆæœ¬:      $tag_version_clean"
          echo "  pubspec ç‰ˆæœ¬:  $pubspec_version"
          
          if [ "$tag_version_clean" != "$pubspec_version" ]; then
            echo ""
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼"
            echo ""
            echo "æ¨é€çš„ tag ç‰ˆæœ¬ ($tag_version) ä¸ pubspec.yaml ä¸­çš„ç‰ˆæœ¬ ($pubspec_version) ä¸åŒ¹é…ã€‚"
            echo ""
            echo "è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š"
            echo "  1. æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬å·ä¸º $tag_version_clean"
            echo "  2. åˆ é™¤å½“å‰ tag å¹¶æ¨é€æ­£ç¡®çš„ tag: v$pubspec_version"
            echo ""
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º Windows-${{ matrix.arch }}
    needs: prepare
    strategy:
      matrix:
        include:
          - arch: x64
            runs-on: windows-latest
          - arch: arm64
            runs-on: windows-11-arm
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        shell: pwsh
        run: |
          Write-Host "============================================"
          Write-Host "ğŸ“¦ åŒ…å:        ${{ needs.prepare.outputs.pkg }}"
          Write-Host "â« ç‰ˆæœ¬å·:      ${{ needs.prepare.outputs.version }}"
          Write-Host "ğŸ·ï¸ Tag:         ${{ needs.prepare.outputs.tag }}"
          Write-Host "ğŸ–¥ï¸ æ¶æ„:        ${{ matrix.arch }}"
          Write-Host "============================================"

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          
          Write-Host "  â¤ å®‰è£… Flutter ä¸»é¡¹ç›®ä¾èµ–"
          flutter pub get
          
          Write-Host "  â¤ å®‰è£… rinf_cli"
          cargo install rinf_cli
          
          Write-Host "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: æ„å»ºåº”ç”¨ç¨‹åº
        shell: pwsh
        run: |
          Write-Host "ğŸ—ï¸ æ­£åœ¨æ„å»º Release ç‰ˆæœ¬..."
          flutter build windows --release -v

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        shell: pwsh
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          PKG: ${{ needs.prepare.outputs.pkg }}
          ARCH: ${{ matrix.arch }}
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          $pkg = $env:PKG
          $version = $env:VERSION
          $arch = $env:ARCH

          Write-Host "ğŸ”§ æ‰“åŒ…ï¼šåŒ…å=$pkg  ç‰ˆæœ¬=$version æ¶æ„=$arch"

          $releaseZip = "${pkg}-windows-${arch}-v${version}.zip"

          Compress-Archive -Path "build/windows/$arch/runner/Release/*" `
            -DestinationPath "dist/$releaseZip"

          Write-Host "ğŸ“¦ äº§ç‰©æ–‡ä»¶: dist/$releaseZip"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.pkg }}-windows-${{ matrix.arch }}
          path: dist/*.zip
          retention-days: 90

  # ------------ åˆ›å»ºæ­£å¼å‘å¸ƒ ------------
  release:
    name: åˆ›å»ºæ­£å¼å‘å¸ƒ
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "ğŸ“ æ­£åœ¨ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          
          # è·å–æ‰€æœ‰æ­£å¼ç‰ˆ tagï¼ˆæ’é™¤å½“å‰ tagï¼‰
          all_release_tags=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$')
          
          echo "ğŸ” æ‰€æœ‰æ­£å¼ç‰ˆ tag:"
          echo "$all_release_tags"
          echo ""
          
          # æ’é™¤å½“å‰ tagï¼Œè·å–ä¸Šä¸€ä¸ªæ­£å¼ç‰ˆ
          previous_tag=$(echo "$all_release_tags" | grep -v "^${current_tag}$" | head -n 1)
          
          if [ -z "$previous_tag" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ tagï¼Œä½¿ç”¨é¦–ä¸ªæäº¤"
            previous_tag=$(git rev-list --max-parents=0 HEAD)
          fi
          
          echo "ğŸ“ ç‰ˆæœ¬èŒƒå›´: $previous_tag â†’ $current_tag"
          
          # ç”Ÿæˆæäº¤æ—¥å¿—ï¼ˆç®€å•åˆ—è¡¨ï¼‰
          {
            echo "## ğŸ“‹ æ›´æ–°æ—¥å¿—"
            echo ""
            echo "è‡ª $previous_tag ä»¥æ¥çš„æ‰€æœ‰æäº¤ï¼š"
            echo ""
            
            # åˆ—å‡ºæ‰€æœ‰æäº¤ï¼ˆåŒ…å«å®Œæ•´ä¿¡æ¯ï¼‰
            git log $previous_tag..HEAD --no-merges --pretty=format:"### %s%n%n**æäº¤**: \`%h\` | **ä½œè€…**: %an | **æ—¶é—´**: %ar%n%n%b%n---" | sed '/^$/d'
            
            echo ""
            echo ""
            
            # æäº¤ç»Ÿè®¡
            commit_count=$(git rev-list --count $previous_tag..HEAD --no-merges)
            echo "---"
            echo ""
            echo "**æœ¬æ¬¡æ›´æ–°åŒ…å« $commit_count ä¸ªæäº¤**"
            
          } > changelog.md
          
          # è¾“å‡ºåˆ° GitHub Actions
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.tag }}
          body: |
            ## ğŸ‰ ${{ needs.prepare.outputs.pkg }} ${{ needs.prepare.outputs.version }} æ­£å¼ç‰ˆ
            
            > ğŸ¯ è¿™æ˜¯ç»è¿‡æµ‹è¯•çš„ç¨³å®šç‰ˆæœ¬ï¼Œæ¨èæ‰€æœ‰ç”¨æˆ·æ›´æ–°ã€‚
            
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **åŒ…å** | `${{ needs.prepare.outputs.pkg }}` |
            | **ç‰ˆæœ¬å·** | `${{ needs.prepare.outputs.version }}` |
            | **æäº¤å“ˆå¸Œ** | [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            
            - **x64**: é€‚ç”¨äº Intel/AMD 64ä½å¤„ç†å™¨ï¼ˆæ¨èï¼‰
            - **arm64**: é€‚ç”¨äº ARM64 å¤„ç†å™¨
            
            ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
            
            - **æ“ä½œç³»ç»Ÿ**: Windows 10 1809+ (64-bit)
            - **ç£ç›˜ç©ºé—´**: è‡³å°‘ 100 MB
            
            ### ğŸ“ å®‰è£…è¯´æ˜
            
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ ZIP æ–‡ä»¶
            2. è§£å‹åˆ°åˆé€‚çš„ç›®å½•
            3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
            
            ### âš ï¸ é‡è¦æç¤º
            
            - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–æäº¤ Issue
            - åé¦ˆé—®é¢˜æ—¶è¯·é™„ä¸Šç›¸å…³æ—¥å¿—æ–‡ä»¶

          files: artifacts/**/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
